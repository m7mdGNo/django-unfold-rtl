<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث عن دواء - {{pharmacy.pharmacy_name}}</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo for Arabic text -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&amp;display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <meta name="color-scheme" content="dark light">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              cairo: ['Cairo', 'sans-serif'],
            },
            colors: {
              primary: {
                light: '#3b82f6',
                DEFAULT: '#2563eb',
                dark: '#1e40af'
              },
              accent: '#06b6d4',
              surface: {
                light: '#f9fafb',
                dark: '#1e293b'
              }
            },
            boxShadow: {
              'elevated': '0 4px 32px 0 rgba(0,0,0,0.10)'
            }
          }
        }
      }
    </script>
    <style>
      html, body { font-family: 'Cairo', sans-serif; }
      .tw-modal-bg { background: rgba(0,0,0,0.5); }
      @keyframes spin { to { transform: rotate(360deg); } }
      .tw-spinner { animation: spin 1s linear infinite; }
      .theme-toggle:focus { outline: 2px solid #2563eb; }
      ::selection { background: #2563eb22; }
      .dark ::selection { background: #60a5fa44; }
      .focus-ring:focus { outline: 2px solid #2563eb; outline-offset: 2px; }
      /* Custom arrow for select (RTL) */
      .custom-select-arrow {
        pointer-events: none;
        position: absolute;
        right: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
      }
      .dark .custom-select-arrow {
        color: #64748b;
      }
      /* Hide default arrow */
      select::-ms-expand { display: none; }
      select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }
      /* Branch badge styles */
      .branch-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3em;
        background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%);
        color: #fff;
        font-size: 0.85rem;
        font-weight: bold;
        border-radius: 9999px;
        padding: 0.25em 0.9em 0.25em 0.9em;
        box-shadow: 0 2px 8px 0 rgba(59,130,246,0.08);
        margin-top: 0.3em;
        margin-bottom: 0.1em;
        white-space: nowrap;
        letter-spacing: 0.01em;
        transition: background 0.2s;
      }
      .dark .branch-badge {
        background: linear-gradient(90deg, #06b6d4 0%, #1e40af 100%);
        color: #fff;
      }
    </style>
</head>
<body class="bg-surface-light dark:bg-surface-dark text-gray-800 dark:text-gray-100 flex flex-col min-h-screen transition-colors duration-300">

    <!-- Theme Toggle Button -->
    <button id="theme-toggle" aria-label="تبديل الوضع الليلي" class="theme-toggle fixed top-4 left-4 z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-lg rounded-full p-2 transition hover:bg-primary-light hover:text-white dark:hover:bg-primary-dark dark:hover:text-white text-primary-dark dark:text-primary-light">
      <i id="theme-toggle-icon" class="fas fa-moon"></i>
    </button>

    <!-- Header -->
    <header class="bg-white/90 dark:bg-gray-900/90 shadow-md border-b border-gray-200 dark:border-gray-800 py-8 text-center relative z-10 transition">
        <div class="container mx-auto flex flex-col items-center">
            <img src="{{ pharmacy.pharmacy_logo.url }}" alt="شعار صيدلية الشفاء" class="mx-auto mb-4 rounded-lg shadow-lg border-4 border-primary-light dark:border-primary-dark bg-white dark:bg-gray-900" style="max-height:80px;">
            <h1 class="text-4xl font-extrabold text-primary-dark dark:text-primary-light mb-2 tracking-tight drop-shadow-sm">{{ pharmacy.pharmacy_name }}</h1>
            <p class="text-gray-700 dark:text-gray-300 text-lg max-w-2xl mx-auto font-medium">ابحث بسهولة عن توفر الأدوية في جميع فروعنا</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto flex-1 py-8 px-2">
        <div class="w-full max-w-3xl mx-auto flex flex-col gap-6">

            <!-- Unified Search Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-elevated p-6 border border-gray-100 dark:border-gray-700 transition">
                <form id="medicine-search-form" class="flex flex-col md:flex-row gap-4 items-stretch md:items-end">
                    <div class="flex-1 flex flex-col gap-2">
                        <label for="search-input" class="text-primary-dark dark:text-primary-light font-bold text-lg flex items-center gap-2">
                            <i class="fas fa-pills text-primary-light dark:text-primary-light"></i>
                            ابحث عن دواء
                        </label>
                        <div class="relative">
                            <input type="text" id="search-input" class="w-full rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-surface-light dark:bg-gray-900 px-12 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark transition text-right font-medium shadow-sm" placeholder="اسم الدواء التجاري أو العلمي..." autocomplete="off" required>
                            <span class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500 text-xl pointer-events-none"><i class="fas fa-pills"></i></span>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col gap-2">
                        <label for="branch-select" class="text-primary-dark dark:text-primary-light font-bold text-lg flex items-center gap-2">
                            <i class="fas fa-location-dot text-primary-light dark:text-primary-light"></i>
                            اختر الفرع
                        </label>
                        <select id="branch-select" class="w-full rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-surface-light dark:bg-gray-900 px-6 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark transition text-right font-medium shadow-sm" required>
                            <option value="">كل الفروع</option>
                            {% for branch in branches %}
                                <option value="{{ branch.id }}">{{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>

            <!-- Search Results & Loading -->
            <div id="search-results-section" class="w-full">
                <div id="loading-indicator" class="flex flex-col items-center justify-center bg-white dark:bg-gray-800 rounded-2xl shadow-elevated p-10 min-h-[150px] text-center border border-gray-100 dark:border-gray-700 transition" style="display: none;">
                    <div class="w-14 h-14 border-4 border-primary-light dark:border-primary-dark border-t-transparent rounded-full tw-spinner mx-auto"></div>
                    <p class="mt-4 text-gray-500 dark:text-gray-400">جاري البحث عن الأدوية...</p>
                </div>
                <div id="search-results" class="min-h-[160px]">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-elevated flex flex-col items-center justify-center p-10 min-h-[200px] text-center border border-gray-100 dark:border-gray-700 transition" id="search-results-message">
                        <i class="fas fa-stethoscope text-primary-light dark:text-primary-light text-5xl mb-4"></i>
                        <p class="text-2xl font-bold mb-2">ابدأ البحث عن دواء</p>
                        <p class="text-gray-500 dark:text-gray-400">أدخل اسم الدواء واختر الفرع (اختياري).</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white/90 dark:bg-gray-900/90 border-t-4 border-primary-light dark:border-primary-dark shadow-inner mt-16 transition">
        <div class="container mx-auto py-10">
            <div class="flex flex-col md:flex-row md:justify-between gap-8">
                <div class="md:w-5/12">
                    <h6 class="flex items-center text-gray-800 dark:text-gray-100 font-bold text-lg mb-4"><i class="fas fa-address-book ml-2 text-primary-light dark:text-primary-light"></i>معلومات الاتصال</h6>
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <i class="fas fa-location-dot ml-3 mt-1 text-primary-light dark:text-primary-light w-4 text-center"></i>
                            <span>{{ pharmacy.pharmacy_address }}</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-phone-volume ml-3 mt-1 text-primary-light dark:text-primary-light w-4 text-center"></i>
                            <span>{{ pharmacy.pharmacy_phone }}</span>
                        </li>
                    </ul>
                </div>
                <div class="md:w-4/12">
                    <h6 class="flex items-center text-gray-800 dark:text-gray-100 font-bold text-lg mb-4"><i class="fas fa-business-time ml-2 text-primary-light dark:text-primary-light"></i>ساعات العمل</h6>
                    <p class="leading-8">من {{ pharmacy.work_start_time }} إلى {{ pharmacy.work_end_time }} يوميًا</p>
                </div>
                <div class="md:w-3/12">
                    <h6 class="flex items-center text-gray-800 dark:text-gray-100 font-bold text-lg mb-4"><i class="fas fa-laptop-code ml-2 text-primary-light dark:text-primary-light"></i>تطوير</h6>
                    <p class="leading-8">
                        تم التطوير بواسطة
                        <a href="https://moez-tech.com/" target="_blank" class="text-primary-light dark:text-primary-light font-semibold hover:text-primary-dark dark:hover:text-primary-dark transition">الجنايني تكنولوجي</a>
                    </p>
                </div>
            </div>
        </div>
        <div class="bg-primary-light/10 dark:bg-primary-dark/10 py-4 text-center text-gray-500 dark:text-gray-400 text-sm">
            جميع الحقوق محفوظة © 2025 لـ <strong class="text-gray-800 dark:text-gray-100">{{ pharmacy.pharmacy_name }}</strong>
        </div>
    </footer>

    <!-- Redesigned Modal for Medicine Details -->
    <div id="medicineDetailModal" class="fixed inset-0 z-50 flex items-center justify-center tw-modal-bg hidden">
        <div class="bg-white dark:bg-gray-900 rounded-3xl shadow-2xl w-full max-w-3xl mx-4 border border-gray-100 dark:border-gray-700 transition relative overflow-hidden">
            <!-- Decorative top bar -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-l from-primary-light via-accent to-primary-dark"></div>
            <div class="flex items-center justify-between px-8 py-6 border-b border-gray-100 dark:border-gray-700 bg-gradient-to-l from-primary-light/90 via-accent/80 to-primary-dark/90 rounded-t-3xl">
                <div class="flex items-center gap-3">
                    <i class="fas fa-capsules text-2xl text-white drop-shadow"></i>
                    <h5 class="text-2xl font-extrabold text-white drop-shadow" id="medicineDetailModalLabel">تفاصيل الدواء</h5>
                </div>
                <button type="button" class="text-white text-3xl hover:text-gray-200 focus:outline-none" onclick="closeMedicineModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="p-8">
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Medicine Image with shadow and badge -->
                    <div class="md:w-1/3 flex flex-col items-center justify-center">
                        <div class="relative">
                            <img id="modal-image" src="https://placehold.co/200x200/EAF3F8/A0B0C0?text=لا+صورة" class="rounded-2xl mb-3 w-44 h-44 object-cover border-2 border-primary-light dark:border-primary-dark bg-white dark:bg-gray-800 shadow-lg" alt="صورة الدواء" onerror="this.onerror=null;this.src='https://placehold.co/200x200/EAF3F8/A0B0C0?text=لا+صورة';">
                            <span id="modal-category-badge" class="absolute bottom-2 left-2 bg-accent/90 text-white text-xs font-bold px-3 py-1 rounded-full shadow hidden"></span>
                        </div>
                    </div>
                    <!-- Medicine Details -->
                    <div class="md:w-2/3 flex flex-col gap-2">
                        <h3 id="modal-trade-name" class="font-extrabold text-primary-dark dark:text-primary-light text-2xl mb-1"></h3>
                        <p id="modal-scientific-name" class="text-gray-500 dark:text-gray-300 text-lg mb-2"></p>
                        <div class="flex flex-wrap gap-2 mb-2 items-center">
                            <span class="flex items-center gap-1 text-sm text-gray-700 dark:text-gray-200">
                                <i class="fas fa-industry text-primary-light dark:text-primary-light"></i>
                                <span id="modal-manufacturer"></span>
                            </span>
                            <span id="modal-branch-name-container" class="branch-badge hidden ml-2">
                                <i class="fas fa-location-dot"></i>
                                <span id="modal-branch-name"></span>
                            </span>
                        </div>
                        <div class="flex flex-row gap-4 mb-2">
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500 dark:text-gray-400">سعر العلبة</span>
                                <span id="modal-price-box" class="font-bold text-green-600 dark:text-green-400 text-lg"></span>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500 dark:text-gray-400">سعر الشريط</span>
                                <span id="modal-price-strip" class="font-bold text-green-600 dark:text-green-400 text-lg"></span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span id="modal-category-chip" class="bg-primary-light/10 dark:bg-primary-dark/20 text-primary-dark dark:text-primary-light text-xs font-semibold px-3 py-1 rounded-full hidden"></span>
                        </div>
                    </div>
                </div>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="modal-description-container" class="bg-surface-light dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-align-left text-primary-light dark:text-primary-light"></i>
                            <h6 class="font-bold text-base">وصف عام</h6>
                        </div>
                        <p id="modal-description" class="text-gray-700 dark:text-gray-200 text-sm"></p>
                    </div>
                    <div id="modal-usage-container" class="bg-surface-light dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-notes-medical text-primary-light dark:text-primary-light"></i>
                            <h6 class="font-bold text-base">دواعي الاستعمال</h6>
                        </div>
                        <p id="modal-usage-info" class="text-gray-700 dark:text-gray-200 text-sm"></p>
                    </div>
                    <div id="modal-warnings-container" class="bg-surface-light dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-triangle-exclamation text-red-500 dark:text-red-400"></i>
                            <h6 class="font-bold text-base text-red-600 dark:text-red-400">تحذيرات خاصة</h6>
                        </div>
                        <p id="modal-warnings" class="text-red-600 dark:text-red-400 text-sm"></p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end px-8 py-6 border-t border-gray-100 dark:border-gray-700 bg-surface-light dark:bg-gray-900 rounded-b-3xl">
                <button type="button" class="bg-primary-light hover:bg-primary-dark text-white font-semibold px-8 py-2 rounded-xl transition shadow" onclick="closeMedicineModal()">
                    <i class="fas fa-times ml-2"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    <script>
      // Theme toggle logic
      const themeToggle = document.getElementById('theme-toggle');
      const themeToggleIcon = document.getElementById('theme-toggle-icon');
      function setTheme(dark) {
        if (dark) {
          document.documentElement.classList.add('dark');
          themeToggleIcon.classList.remove('fa-moon');
          themeToggleIcon.classList.add('fa-sun');
        } else {
          document.documentElement.classList.remove('dark');
          themeToggleIcon.classList.remove('fa-sun');
          themeToggleIcon.classList.add('fa-moon');
        }
      }
      // Initial theme
      (function() {
        let userTheme = localStorage.getItem('theme');
        if (userTheme === 'dark' || (!userTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          setTheme(true);
        } else {
          setTheme(false);
        }
      })();
      themeToggle.addEventListener('click', function() {
        let isDark = document.documentElement.classList.toggle('dark');
        setTheme(isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });

      // Modal open/close logic for Tailwind modal
      function openMedicineModal() {
        document.getElementById('medicineDetailModal').classList.remove('hidden');
      }
      function closeMedicineModal() {
        document.getElementById('medicineDetailModal').classList.add('hidden');
      }
      document.addEventListener('keydown', function(e) {
        if (e.key === "Escape") closeMedicineModal();
      });
      document.getElementById('medicineDetailModal').addEventListener('click', function(e) {
        if (e.target === this) closeMedicineModal();
      });

      // Debounce function to limit API calls
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Search logic
      document.addEventListener('DOMContentLoaded', function() {
        var searchForm = document.getElementById('medicine-search-form');
        var searchInput = document.getElementById('search-input');
        var branchSelect = document.getElementById('branch-select');
        var searchResults = document.getElementById('search-results');
        var loadingIndicator = document.getElementById('loading-indicator');

        // Helper to render search results
        function renderResults(medicines) {
          if (!medicines) medicines = [];
          if (typeof medicines === 'string') {
            try { medicines = JSON.parse(medicines); } catch (e) { medicines = []; }
          }
          if (!Array.isArray(medicines) && typeof medicines === 'object' && medicines !== null) {
            if (Array.isArray(medicines.results)) {
              medicines = medicines.results;
            } else {
              let keys = Object.keys(medicines);
              if (keys.length && keys.every(k => !isNaN(Number(k)))) {
                medicines = keys.map(k => medicines[k]);
              } else if ('trade_name' in medicines || 'scientific_name' in medicines) {
                medicines = [medicines];
              } else {
                medicines = [];
              }
            }
          }
          if (!Array.isArray(medicines)) medicines = [];
          medicines = medicines.filter(Boolean);

          if (medicines.length === 0) {
            searchResults.innerHTML = `
              <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-elevated flex flex-col items-center justify-center p-10 min-h-[200px] text-center border border-gray-100 dark:border-gray-700 transition" id="search-results-message">
                <i class="fas fa-circle-exclamation text-gray-400 dark:text-gray-500 text-5xl mb-4"></i>
                <p class="text-2xl font-bold mb-2">لا توجد نتائج</p>
                <p class="text-gray-500 dark:text-gray-400">لم يتم العثور على أدوية مطابقة.</p>
              </div>
            `;
            return;
          }
          let html = '<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-elevated p-4 border border-gray-100 dark:border-gray-700 transition"><ul class="divide-y divide-gray-100 dark:divide-gray-700">';
          medicines.forEach(function(med) {
            if (!med) return;
            if (typeof med === 'string') {
              try { med = JSON.parse(med); } catch (e) { return; }
            }
            let image = med.image ? med.image : 'https://placehold.co/60x60/EAF3F8/A0B0C0?text=لا+صورة';
            let priceBox = med.box_price !== undefined && med.box_price !== null ? med.box_price : (med.price_box !== undefined ? med.price_box : '');
            if (typeof priceBox === 'object' && priceBox !== null && priceBox.toString) priceBox = priceBox.toString();
            let branchName = med.branch_name || '';
            html += `
              <li class="py-4 flex items-center justify-between cursor-pointer hover:bg-primary-light/10 dark:hover:bg-primary-dark/10 transition rounded-xl px-2" onclick="showMedicineDetailModal('${encodeURIComponent(JSON.stringify(med))}')">
                <div class="flex items-center gap-4">
                  <img src="${image}" alt="صورة الدواء" class="w-16 h-16 rounded-lg object-cover border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" onerror="this.onerror=null;this.src='https://placehold.co/60x60/EAF3F8/A0B0C0?text=لا+صورة';">
                  <div class="text-right">
                    <div class="font-bold text-primary-dark dark:text-primary-light text-lg">${med.trade_name || ''}</div>
                    <div class="text-gray-500 dark:text-gray-300 text-sm">${med.scientific_name || ''}</div>
                    ${branchName ? `<span class="branch-badge mt-2"><i class='fas fa-location-dot'></i><span>${branchName}</span></span>` : ''}
                  </div>
                </div>
                <div class="text-green-600 dark:text-green-400 font-bold text-lg">${priceBox ? priceBox + ' ج.م' : ''}</div>
              </li>
            `;
          });
          html += '</ul></div>';
          searchResults.innerHTML = html;
        }

        // Show loading indicator
        function showLoading() {
          if (loadingIndicator) loadingIndicator.style.display = '';
        }
        // Hide loading indicator
        function hideLoading() {
          if (loadingIndicator) loadingIndicator.style.display = 'none';
        }

        // Fetch medicines from endpoint
        function fetchMedicines(query, branchId) {
          if (!query) {
            searchResults.innerHTML = `
              <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-elevated flex flex-col items-center justify-center p-10 min-h-[200px] text-center border border-gray-100 dark:border-gray-700 transition" id="search-results-message">
                <i class="fas fa-stethoscope text-primary-light dark:text-primary-light text-5xl mb-4"></i>
                <p class="text-2xl font-bold mb-2">ابدأ البحث عن دواء</p>
                <p class="text-gray-500 dark:text-gray-400">أدخل اسم الدواء واختر الفرع (اختياري) ثم اضغط بحث.</p>
              </div>
            `;
            return;
          }
          showLoading();
          let url = `/en/search-medicine?query=${encodeURIComponent(query)}`;
          if (branchId) url += `&branch_id=${encodeURIComponent(branchId)}`;
          fetch(url)
            .then(response => response.json())
            .then(data => {
              hideLoading();
              data = data.medicines;
              if (typeof data === 'string') {
                try { data = JSON.parse(data); } catch (e) { data = []; }
              }
              if (Array.isArray(data)) {
                renderResults(data);
              } else if (data && Array.isArray(data.results)) {
                renderResults(data.results);
              } else if (data && typeof data === 'object') {
                let keys = Object.keys(data);
                if (keys.length && keys.every(k => !isNaN(Number(k)))) {
                  let arr = keys.map(k => data[k]);
                  renderResults(arr);
                } else if ('trade_name' in data || 'scientific_name' in data) {
                  renderResults([data]);
                } else {
                  renderResults([]);
                }
              } else {
                renderResults([]);
              }
            })
            .catch(err => {
              hideLoading();
              searchResults.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-elevated flex flex-col items-center justify-center p-10 min-h-[200px] text-center border border-gray-100 dark:border-gray-700 transition">
                  <i class="fas fa-triangle-exclamation text-red-500 dark:text-red-400 text-5xl mb-4"></i>
                  <p class="text-2xl font-bold mb-2">حدث خطأ أثناء البحث</p>
                  <p class="text-gray-500 dark:text-gray-400">يرجى المحاولة مرة أخرى لاحقًا.</p>
                </div>
              `;
            });
        }

        // Debounced search handler
        var debouncedSearch = debounce(function() {
          var query = searchInput.value.trim();
          var branchId = branchSelect.value;
          fetchMedicines(query, branchId);
        }, 400);

        // Form submit handler
        searchForm.addEventListener('submit', function(e) {
          e.preventDefault();
          var query = searchInput.value.trim();
          var branchId = branchSelect.value;
          fetchMedicines(query, branchId);
        });

        // Live search on input
        searchInput.addEventListener('input', function() {
          if (searchInput.value.trim().length > 1) {
            debouncedSearch();
          }
        });

        // Also allow changing branch to re-search if query is present
        branchSelect.addEventListener('change', function() {
          if (searchInput.value.trim().length > 1) {
            debouncedSearch();
          }
        });
      });

      // Show medicine details in modal (redesigned)
      function showMedicineDetailModal(medObj) {
        let med;
        if (typeof medObj === 'string') {
          try { med = JSON.parse(decodeURIComponent(medObj)); } catch { med = {}; }
        } else {
          med = medObj;
        }
        let image = med.image ? med.image : 'https://placehold.co/200x200/EAF3F8/A0B0C0?text=لا+صورة';
        document.getElementById('modal-image').src = image;
        document.getElementById('modal-trade-name').textContent = med.trade_name || '';
        document.getElementById('modal-scientific-name').textContent = med.scientific_name || '';
        document.getElementById('modal-manufacturer').textContent = med.manufacturer || '';
        // Branch name
        let branchName = med.branch_name || '';
        let branchNameContainer = document.getElementById('modal-branch-name-container');
        let branchNameSpan = document.getElementById('modal-branch-name');
        if (branchName) {
          branchNameContainer.classList.remove('hidden');
          branchNameSpan.textContent = branchName;
        } else {
          branchNameContainer.classList.add('hidden');
          branchNameSpan.textContent = '';
        }
        // Category badge and chip
        let category = med.category || '';
        let badge = document.getElementById('modal-category-badge');
        let chip = document.getElementById('modal-category-chip');
        if (category) {
          badge.textContent = category;
          badge.classList.remove('hidden');
          chip.textContent = category;
          chip.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
          chip.classList.add('hidden');
        }
        // Prices
        let priceBox = med.box_price !== undefined && med.box_price !== null ? med.box_price : (med.price_box !== undefined ? med.price_box : '');
        let priceStrip = med.strip_price !== undefined && med.strip_price !== null ? med.strip_price : (med.price_strip !== undefined ? med.price_strip : '');
        if (typeof priceBox === 'object' && priceBox !== null && priceBox.toString) priceBox = priceBox.toString();
        if (typeof priceStrip === 'object' && priceStrip !== null && priceStrip.toString) priceStrip = priceStrip.toString();
        document.getElementById('modal-price-box').textContent = priceBox ? priceBox + ' ج.م' : '';
        document.getElementById('modal-price-strip').textContent = priceStrip ? priceStrip + ' ج.م' : '';
        // Description, usage, warnings
        document.getElementById('modal-description').textContent = med.description || '';
        document.getElementById('modal-usage-info').textContent = med.indications || med.usage_info || '';
        document.getElementById('modal-warnings').textContent = med.special_warnings || med.warnings || '';
        openMedicineModal();
      }
    </script>
</body>
</html>